(function(f,o){typeof exports=="object"&&typeof module<"u"?o(exports):typeof define=="function"&&define.amd?define(["exports"],o):(f=typeof globalThis<"u"?globalThis:f||self,o(f.PaystoreEcommerceSdk={}))})(this,(function(f){"use strict";var o=(e=>(e.FRICTIONLESS="FRICTIONLESS",e.ACS_URL_CHALLENGE="ACS_URL_CHALLENGE",e.ACS_FORM_CHALLENGE="ACS_FORM_CHALLENGE",e.IFRAME_CHALLENGE="IFRAME_CHALLENGE",e.JAVASCRIPT="JAVASCRIPT",e))(o||{}),h=(e=>(e.PROCESSING="PROCESSING",e.PENDING="PENDING",e.WAITING_VALIDATION="WAITING_VALIDATION",e.WAITING_CAPTURE="WAITING_CAPTURE",e.CONFIRMED="CONFIRMED",e.DECLINED="DECLINED",e.REFUNDED="REFUNDED",e.ERROR="ERROR",e.CANCELLED="CANCELLED",e.WAITING_PAYMENT="WAITING_PAYMENT",e.WAITING_3DS_AUTHENTICATION="WAITING_3DS_AUTHENTICATION",e.PENDING_NOT_RESOLVED="PENDING_NOT_RESOLVED",e.WAITING_ANTIFRAUD="WAITING_ANTIFRAUD",e.WAITING_CANCELLATION="WAITING_CANCELLATION",e))(h||{});const A=["CONFIRMED"],C=["DECLINED","ERROR","CANCELLED","REFUNDED"];function m(e){return A.includes(e)||C.includes(e)}class T{apiToken;baseUrl;PAYMENT_ENDPOINT_PATH="/ecommerce/v1/payment";async init(t){const r=[];if((!t.base_url||t.base_url.trim()==="")&&r.push({field:"base_url",cause:"base_url is required and cannot be empty"}),r.length>0&&t.onInvalid){t.onInvalid(r);return}this.apiToken=t.api_token,this.baseUrl=t.base_url}setApiKey(t){this.apiToken=t}setBaseUrl(t){this.baseUrl=t}async fetchPaymentStatus(t){const i=`${this.baseUrl.replace(/\/$/,"")}${this.PAYMENT_ENDPOINT_PATH}/${t}`,a=this.apiToken,l=await fetch(i,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`}});if(!l.ok){const n=await l.text();return Promise.reject({status:"ERROR",message:`Failed to fetch payment status. HTTP ${l.status}: ${n}`,paymentIdentifier:t})}const u=await l.json();return!u.payment_authorization||!u.payment_authorization.status?Promise.reject({status:"ERROR",message:"Internal error: Failed to verify transaction.",paymentIdentifier:t}):u}}async function p(e){const{fetchStatus:t,onStep:r}=e,i=1e3,a=180;return new Promise((l,u)=>{let n=0,d;const s=async()=>{n++;try{const c=await t(),_=c.payment_authorization?.status;if(r&&r(c),m(_)){clearTimeout(d),l(c);return}}catch{}if(n>=a){clearTimeout(d),u({status:"TIMEOUT",message:`Polling timed out after ${n} attempts.`});return}d=setTimeout(s,i)};s()})}function S(e){return e?{valid:!0}:{valid:!1,error:{field:"apiToken",cause:"API token is required."}}}function N(e,t,r){return t.includes(e)?{valid:!0}:{valid:!1,error:{field:"mode",cause:`${r} provider does not support mode ${o}.`}}}function I(e){return e?{valid:!0}:{valid:!1,error:{field:"threeDSInfo.acs_url",cause:"Missing 'acs_url'."}}}class L extends T{providerName="Rede";WINDOW_TARGET_NAME="paystoreThreeDSAuthWindow";supportedTypes=[o.ACS_URL_CHALLENGE,o.FRICTIONLESS];async authenticate(t){const{payment_identifier:r,three_ds_type:i,three_ds_info:a,onSuccess:l=()=>{},onFailure:u=()=>{},onInvalid:n=()=>{}}=t,d=S(this.apiToken);if(!d.valid){n([d.error]);return}const s=N(i,this.supportedTypes,this.providerName);if(!s.valid){n([s.error]);return}if(!a){n([{field:"three_ds_info",cause:"Missing three_ds_info"}]);return}if(i===o.ACS_URL_CHALLENGE){const c=I(a.acs_url);if(!c.valid){n([c.error]);return}typeof window<"u"&&window.open(a.acs_url,this.WINDOW_TARGET_NAME)}try{const c=await p({fetchStatus:()=>this.fetchPaymentStatus(r)});l(c)}catch(c){u(c)}}}class y extends T{providerName="Shift4";WINDOW_TARGET_NAME="paystoreThreeDSAuthWindow";supportedTypes=[o.ACS_URL_CHALLENGE,o.FRICTIONLESS];async authenticate(t){const{payment_identifier:r,three_ds_type:i,three_ds_info:a,onSuccess:l=()=>{},onFailure:u=()=>{},onInvalid:n=()=>{}}=t,d=S(this.apiToken);if(!d.valid){n([d.error]);return}const s=N(i,this.supportedTypes,this.providerName);if(!s.valid){n([s.error]);return}if(!a){n([{field:"three_ds_info",cause:"Missing three_ds_info"}]);return}if(i===o.ACS_URL_CHALLENGE){const c=I(a.acs_url);if(!c.valid){n([c.error]);return}typeof window<"u"&&window.open(a.acs_url,this.WINDOW_TARGET_NAME)}try{const c=await p({fetchStatus:()=>this.fetchPaymentStatus(r)});l(c)}catch(c){u(c)}}}class D extends T{METHOD_NOTIFICATION_PATH="/ecommerce/v1/3ds/method/globalPayments";WINDOW_TARGET_NAME="paystoreThreeDSAuthWindow";lastExecutedChallengeType=null;supportedTypes=[o.FRICTIONLESS,o.ACS_FORM_CHALLENGE,o.IFRAME_CHALLENGE];createInput(t,r){const i=document.createElement("input");return i.type="hidden",i.name=t,i.value=r,i}performIframeChallenge(t,r){const i=`${this.baseUrl}${this.METHOD_NOTIFICATION_PATH}`,l=JSON.stringify({threeDSServerTransID:r,threeDSMethodNotificationURL:i}),u=btoa(l),n=document.createElement("iframe");n.name="hiddenThreeDSIframe",n.style.display="none",n.setAttribute("allow","fullscreen"),n.setAttribute("referrerpolicy","no-referrer"),n.setAttribute("sandbox","allow-scripts allow-forms allow-same-origin"),document.body.appendChild(n);const d=document.createElement("form");d.method="POST",d.action=t,d.setAttribute("target","hiddenThreeDSIframe");const s=this.createInput("threeDSMethodData",u);d.appendChild(s),document.body.appendChild(d),d.submit()}performPostChallenge(t){const r=document.createElement("form");r.method="POST",r.action=t,r.target=this.WINDOW_TARGET_NAME,document.body.appendChild(r),r.submit(),document.body.removeChild(r)}handleNewChallenge(t){const r=t.three_ds_type;if(!r||this.lastExecutedChallengeType===r)return;const i=t.iframe_url||t.acs_url,a=t.trxid;r===o.IFRAME_CHALLENGE?i&&a&&(this.performIframeChallenge(i,a),this.lastExecutedChallengeType=r):r===o.ACS_FORM_CHALLENGE&&i&&(this.performPostChallenge(i),this.lastExecutedChallengeType=r)}async authenticate(t){const{payment_identifier:r,three_ds_type:i,three_ds_info:a,onSuccess:l=()=>{},onFailure:u=()=>{},onInvalid:n=()=>{}}=t;if(typeof window>"u"){n([{field:"environment",cause:"Browser environment required."}]);return}if(!this.apiToken){n([{field:"apiToken",cause:"Missing Token"}]);return}if(!a){n([{field:"threeDSInfo",cause:"Missing threeDSInfo"}]);return}const d=N(i,this.supportedTypes,"Entrepay");if(!d.valid){n([d.error]);return}if(i===o.ACS_FORM_CHALLENGE){const s=I(a.acs_url);if(!s.valid){n([s.error]);return}}if(i===o.IFRAME_CHALLENGE){const s=[];if(!a.acs_url&&!a.iframe_url&&s.push({field:"threeDSInfo.acs_url",cause:"Missing acs_url/iframe_url"}),a.trxid||s.push({field:"threeDSInfo.trxid",cause:"Missing trxid"}),s.length>0){n(s);return}}this.lastExecutedChallengeType=null,i&&a&&this.handleNewChallenge({three_ds_type:i,...a});try{const s=await p({fetchStatus:()=>this.fetchPaymentStatus(r),onStep:_=>{const G=_.payment_authorization?.status,R=_.three_ds_info_response;G===h.WAITING_3DS_AUTHENTICATION&&R&&this.handleNewChallenge(R)}}),c=s.payment_authorization?.status;A.includes(c)?l(s):u(s)}catch(s){u({status:s.status||"ERROR",message:s.message||"Erro desconhecido.",payment_identifier:r})}}}class v{static providerMap={REDE:L,SHIFT4:y,ENTREPAY:D};static create(t,r){const i=this.providerMap[t.toUpperCase()];return i?new i:(r&&r([{field:"acquirerName",cause:`Unknown provider: ${t}`}]),null)}}let E;const O={async init(e){E=e},async authenticate(e){const{onInvalid:t=()=>{}}=e;if(!E||!E.api_token){t([{field:"apiToken",cause:"ProviderAPI.init must be called first."}]);return}const r=v.create(e.acquirer_name);if(!r){t([{field:"acquirerName",cause:`Unknown provider: ${e.acquirer_name}`}]);return}await r.init(E),await r.authenticate(e)}};f.FINAL_FAILURE_STATUSES=C,f.FINAL_SUCCESS_STATUSES=A,f.PaymentStatus=h,f.PaystoreEcommerceProvider=O,f.ThreeDSType=o,f.isFinalStatus=m,Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})}));
//# sourceMappingURL=ps-ecommerce-sdk.umd.js.map
